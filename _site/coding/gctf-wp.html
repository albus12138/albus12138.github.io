<!DOCTYPE html>
<html>
<head>
    <!--
    * Author:         Raphael__
    -->
    <meta charset="utf-8" />
    <title>GCTF Re&Mobile WriteUp | Raphael's Blog</title>
    <meta name="author" content="Raphael" />
    <meta name="renderer" content="webkit">
    <meta name="description" content="Raphael's Blog" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="/css/default.css" type="text/css" />
    <link rel="stylesheet" href="/css/pygments.css" type="text/css" />
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <script src="/js/jquery-1.7.1.min.js" type="text/javascript"></script>
</head>
<body>

    <div class="home-menu">
        <div class="home-icon-con">
            <a class="home-menu-icon" href="/">Raphael</a>
            <a class="home-follow" href="#" title="Contact Me">+</a>
        </div>
    </div>

    <style type="text/css">
    body { background:#e8e8e8; }
    @media screen and (max-width: 750px){
        body { background:#fff; }
    }
    @media screen and (max-width: 1020px){
        body { background:#fff; }
    }
</style>

<div id="content">
    <div class="entry">
        <h1 class="entry-title"><a href="/coding/gctf-wp" title="GCTF Re&Mobile WriteUp">GCTF Re&Mobile WriteUp</a></h1>
        <p class="entry-date">2017-07-01</p>
        <h2 id="0x00-mobile-01-apk逆向">0x00 Mobile-01 APK逆向</h2>

<p><img src="/images/gctf-wp/1.jpg" alt="OnCreate" /></p>

<p>从成功后的Toast提示可以很容易找出判断位置，即CheckSN函数，传入的参数是 “Tenshine”和输入的字符串</p>

<p><img src="/images/gctf-wp/2.jpg" alt="CheckSN" /></p>

<p>检验过程十分简单，检查username是否为空，sn长度是否为22，然后对username进行计算md5，然后以步长为2的方式从md5中取出字符，生成flag字符串</p>

<p>最后，flag为bc72f242a6af3857</p>

<h2 id="0x01-reverse-02-debugexe">0x01 Reverse-02 debug.exe</h2>

<p>用IDA打开exe文件，发现是用.Net编写的，改用dotPeek反编译出源码，其中函数名做了混淆，不过没关系，影响不大</p>

<p><img src="/images/gctf-wp/3.jpg" alt="dotPeek" /></p>

<p>dotPeek对于未加密的程序反编译出源码的效果非常好，将代码简单修改一下写入Visual Studio，运行，得到flag{967DDDFBCD32C1F53527C221D9E40A0B}</p>

<figure class="highlight"><pre><code class="language-c#" data-lang="c#"><span></span><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Security.Cryptography</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Linq</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Text</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Threading.Tasks</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">funcs</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="nf">xor</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="kt">int</span><span class="p">[</span><span class="m">30</span><span class="p">]</span>
        <span class="p">{</span>
            <span class="m">2</span><span class="p">,</span>
            <span class="m">3</span><span class="p">,</span>
            <span class="m">5</span><span class="p">,</span>
            <span class="m">7</span><span class="p">,</span>
            <span class="m">11</span><span class="p">,</span>
            <span class="m">13</span><span class="p">,</span>
            <span class="m">17</span><span class="p">,</span>
            <span class="m">19</span><span class="p">,</span>
            <span class="m">23</span><span class="p">,</span>
            <span class="m">29</span><span class="p">,</span>
            <span class="m">31</span><span class="p">,</span>
            <span class="m">37</span><span class="p">,</span>
            <span class="m">41</span><span class="p">,</span>
            <span class="m">43</span><span class="p">,</span>
            <span class="m">47</span><span class="p">,</span>
            <span class="m">53</span><span class="p">,</span>
            <span class="m">59</span><span class="p">,</span>
            <span class="m">61</span><span class="p">,</span>
            <span class="m">67</span><span class="p">,</span>
            <span class="m">71</span><span class="p">,</span>
            <span class="m">73</span><span class="p">,</span>
            <span class="m">79</span><span class="p">,</span>
            <span class="m">83</span><span class="p">,</span>
            <span class="m">89</span><span class="p">,</span>
            <span class="m">97</span><span class="p">,</span>
            <span class="m">101</span><span class="p">,</span>
            <span class="m">103</span><span class="p">,</span>
            <span class="m">107</span><span class="p">,</span>
            <span class="m">109</span><span class="p">,</span>
            <span class="m">113</span>
        <span class="p">}[</span><span class="n">b</span><span class="p">]</span> <span class="p">^</span> <span class="n">a</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="kt">string</span> <span class="nf">flag</span><span class="p">(</span><span class="kt">string</span> <span class="n">a</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s">&quot;flag{&quot;</span> <span class="p">+</span> <span class="n">BitConverter</span><span class="p">.</span><span class="n">ToString</span><span class="p">(</span><span class="k">new</span> <span class="n">MD5CryptoServiceProvider</span><span class="p">().</span><span class="n">ComputeHash</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">ASCII</span><span class="p">.</span><span class="n">GetBytes</span><span class="p">(</span><span class="n">a</span><span class="p">))).</span><span class="n">Replace</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="p">+</span> <span class="s">&quot;}&quot;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">calc</span><span class="p">(</span><span class="kt">string</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">,</span> <span class="k">ref</span> <span class="kt">string</span> <span class="n">A_2</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="m">0</span> <span class="p">&lt;</span> <span class="n">a</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">do</span>
            <span class="p">{</span>
                <span class="kt">char</span> <span class="n">ch</span> <span class="p">=</span> <span class="n">a</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
                <span class="kt">int</span> <span class="n">A_1_1</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
                <span class="k">do</span>
                <span class="p">{</span>
                    <span class="n">ch</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="n">ToChar</span><span class="p">(</span><span class="n">funcs</span><span class="p">.</span><span class="n">xor</span><span class="p">(</span><span class="n">Convert</span><span class="p">.</span><span class="n">ToInt32</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="n">A_1_1</span><span class="p">));</span>
                    <span class="p">++</span><span class="n">A_1_1</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">A_1_1</span> <span class="p">&lt;</span> <span class="m">15</span><span class="p">);</span>
                <span class="n">A_2</span> <span class="p">=</span> <span class="n">A_2</span> <span class="p">+</span> <span class="p">(</span><span class="kt">object</span><span class="p">)</span><span class="n">ch</span><span class="p">;</span>
                <span class="p">++</span><span class="n">index</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="p">&lt;</span> <span class="n">a</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">A_2</span> <span class="p">=</span> <span class="n">funcs</span><span class="p">.</span><span class="n">flag</span><span class="p">(</span><span class="n">A_2</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">namespace</span> <span class="nn">ConsoleApplication5</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span> 
        <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">A_2</span> <span class="p">=</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="k">null</span><span class="p">;</span>
            <span class="n">funcs</span><span class="p">.</span><span class="n">calc</span><span class="p">(</span><span class="s">&quot;CreateByTenshine&quot;</span><span class="p">,</span> <span class="n">Convert</span><span class="p">.</span><span class="n">ToInt32</span><span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;{0}&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">object</span><span class="p">)(</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="n">Hour</span> <span class="p">+</span> <span class="m">1</span><span class="p">))),</span> <span class="k">ref</span> <span class="n">A_2</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">A_2</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Console</span><span class="p">.</span><span class="n">ReadLine</span><span class="p">()</span> <span class="p">==</span> <span class="n">A_2</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&quot;u got it!&quot;</span><span class="p">);</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
                <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&quot;wrong&quot;</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">ReadKey</span><span class="p">(</span><span class="k">true</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<h2 id="0x02-reverse-03-hackme">0x02 Reverse-03 Hackme</h2>

<p>先运行一下看一遍运行流程，然后用IDA打开，程序内容很多，先搜索一下字符串</p>

<p><img src="/images/gctf-wp/4.jpg" alt="strings" /></p>

<p>看到 <code>Congras\n</code> 和 <code>Oh no!\n</code> 基本上可以确定关键函数位置了</p>

<p><img src="/images/gctf-wp/5.jpg" alt="data" /></p>

<p><img src="/images/gctf-wp/6.jpg" alt="400F8E" /></p>

<p>定位关键内容为中间的do-while循环，这个<em>sub_406D90</em>函数困扰了我很久，甚至用gdb去调试这个函数……但是水平一般没有解出来。在看了其他队伍的wp后发现其实不需要解出这个函数的功能，因为后面对22取模，所以v7的取值范围只能是0~21，写个脚本爆破一下</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span></span><span class="n">byte</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x5f</span><span class="p">,</span><span class="mh">0xf2</span><span class="p">,</span><span class="mh">0x5e</span><span class="p">,</span><span class="mh">0x8b</span><span class="p">,</span><span class="mh">0x4e</span><span class="p">,</span><span class="mh">0xe</span><span class="p">,</span><span class="mh">0xa3</span><span class="p">,</span><span class="mh">0xaa</span><span class="p">,</span><span class="mh">0xc7</span><span class="p">,</span><span class="mh">0x93</span><span class="p">,</span><span class="mh">0x81</span><span class="p">,</span><span class="mh">0x3d</span><span class="p">,</span><span class="mh">0x5f</span><span class="p">,</span><span class="mh">0x74</span><span class="p">,</span><span class="mh">0xa3</span><span class="p">,</span><span class="mh">0x9</span><span class="p">,</span><span class="mh">0x91</span><span class="p">,</span><span class="mh">0x2b</span><span class="p">,</span><span class="mh">0x49</span><span class="p">,</span><span class="mh">0x28</span><span class="p">,</span><span class="mh">0x93</span><span class="p">,</span><span class="mh">0x67</span><span class="p">]</span>
<span class="n">string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="k">for</span> <span class="n">v7</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">22</span><span class="p">):</span>
    <span class="n">v9</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">v6</span> <span class="o">=</span> <span class="n">byte</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">v7</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">v8</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span><span class="p">(</span><span class="n">v8</span> <span class="o">&lt;</span> <span class="n">v4</span><span class="p">):</span>
        <span class="n">v8</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">v9</span> <span class="o">=</span> <span class="mh">0x6d01788d</span> <span class="o">*</span> <span class="n">v9</span> <span class="o">+</span> <span class="mi">12345</span>
    <span class="n">string</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">((</span><span class="n">v9</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">^</span> <span class="n">v6</span><span class="p">)</span>  <span class="c1"># 因为最后 v9^v5 时是 unsigned __int8 所以这里和 0xff 做一下与运算</span>
<span class="k">print</span> <span class="n">string</span></code></pre></figure>

<p>最终结果：flag{d826e6926098ef46}</p>

        <div id="disqus_thread"></div>
		<script type="text/javascript">
		    /* * * CONFIGURATION VARIABLES * * */
		    var disqus_shortname = 'albus12138';
		    
		    /* * * DON'T EDIT BELOW THIS LINE * * */
		    (function() {
		        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		    })();
		</script>
		<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>

    <div class="sidenav">
        <h2>Blog</h2>
        <ul class="artical-list">
        
        
            
            <li><a href="/blog/why-blog">我为什么写博客？</a></li>
            
            
        
        </ul>

        <h2>Coding</h2>
        <ul class="artical-list">
        
        
            
            <li><a href="/coding/python-re">Python正则表达式</a></li>
            
            
        
            
            <li><a href="/coding/xctf-carnival-wp">XCTF嘉年华体验赛 Re部分WriteUp</a></li>
            
            
        
            
            <li><a href="/coding/gctf-wp">GCTF Re&Mobile WriteUp</a></li>
            
            
        
            
            <li><a href="/coding/python-requests">Requests模块</a></li>
            
            
        
            
            <li><a href="/coding/iscc-2017-wp">ISCC2017 WriteUp</a></li>
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
        </ul>

        <h2>Bookmarks</h2>
        <ul class="artical-list">
        
        
            
            <li><a href="/bookmarks/ddos">免费DDOS攻击测试工具</a></li>
            
            
        
            
            <li><a href="/bookmarks/network-traffic-hijacking-2">网络流量攻击的危害</a></li>
            
            
        
            
            <li><a href="/bookmarks/network-traffic-hijacking">网络流量攻击</a></li>
            
            
        
            
            <li><a href="/bookmarks/resouces-for-learn-python">学习Python编程的11个资源</a></li>
            
            
        
            
            <li><a href="/bookmarks/buffer-overflow">缓冲区溢出攻击相关知识</a></li>
            
            
        
        </ul>
    </div>
</div>

<script src="/js/post.js" type="text/javascript"></script>

    <script type="text/javascript">
        $(function(){
            $('.home-follow').click(function(e){
                e.preventDefault();
            });
        })
        $(document).ready(function(){
            var id = Math.floor(Math.random()*5)+1;
            $(".aside").css("background-image","url(/images/bg-"+id+".jpg)");            
        })
    </script>
</body>
</html>
